{% extends "base.html" %}
{% block title %}Binary Ağacı{% endblock %}

{% block content %}
<div class="min-h-[calc(100vh-80px)] bg-surface p-0 lg:p-6 flex flex-col">
    <!-- Control Bar -->
    <div class="bg-white border-b lg:border border-outline-variant/20 lg:rounded-2xl shadow-sm px-4 py-3 flex items-center justify-between z-20 relative">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-primary/10 flex items-center justify-center text-primary">
                <span class="material-symbols-outlined">account_tree</span>
            </div>
            <div>
                <h1 class="text-lg font-display font-bold text-on-surface leading-tight">Binary Ağacı</h1>
                <p class="text-xs text-on-surface-variant hidden sm:block">Ekibinizi detaylı inceleyin ve yönetin</p>
            </div>
        </div>
        
        <div class="flex items-center gap-2">
            <!-- Search Bar -->
            <div class="relative hidden sm:block">
                <input type="text" id="tree-search" placeholder="İsim veya Üye No ile ara..." 
                    class="pl-9 pr-4 py-2 rounded-lg bg-surface-container text-sm text-on-surface focus:outline-none focus:ring-2 focus:ring-primary/20 w-48 transition-all focus:w-64"
                    autocomplete="off">
                <span class="material-symbols-outlined absolute left-2.5 top-1/2 -translate-y-1/2 text-on-surface-variant text-[18px]">search</span>
                
                <!-- Search Results Dropdown -->
                <div id="search-results" class="absolute top-full left-0 w-64 mt-2 bg-white rounded-xl shadow-xl border border-outline-variant/20 max-h-60 overflow-y-auto hidden z-50">
                </div>
            </div>

            <div class="h-6 w-px bg-outline-variant/20 mx-1 hidden sm:block"></div>

            <button onclick="resetZoom()" class="p-2 rounded-lg hover:bg-surface-container text-on-surface-variant hover:text-primary transition-colors" title="Merkeze Odakla">
                <span class="material-symbols-outlined">center_focus_strong</span>
            </button>
            <div class="h-6 w-px bg-outline-variant/20 mx-1"></div>
            <button onclick="zoomOut()" class="p-2 rounded-lg hover:bg-surface-container text-on-surface-variant hover:text-primary transition-colors">
                <span class="material-symbols-outlined">remove</span>
            </button>
            <button onclick="zoomIn()" class="p-2 rounded-lg hover:bg-surface-container text-on-surface-variant hover:text-primary transition-colors">
                <span class="material-symbols-outlined">add</span>
            </button>
        </div>
    </div>

    <!-- Tree Container -->
    <div class="flex-1 relative overflow-hidden bg-surface-container lg:rounded-b-2xl lg:mt-0 border-x border-b border-outline-variant/20 shadow-inner min-h-[600px]">
        <!-- Loading State -->
        <div id="loading-state" class="absolute inset-0 flex flex-col items-center justify-center bg-surface-container z-50">
            <div class="w-12 h-12 border-4 border-primary/30 border-t-primary rounded-full animate-spin mb-4"></div>
            <p class="text-sm font-medium text-on-surface-variant animate-pulse">Ağaç verileri yükleniyor...</p>
        </div>
        
        <!-- Error State -->
        <div id="error-state" class="hidden absolute inset-0 flex-col items-center justify-center bg-surface-container z-50">
            <span class="material-symbols-outlined text-4xl text-error mb-2">error</span>
            <p id="error-message" class="text-error font-medium">Bir hata oluştu</p>
            <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-primary text-white rounded-lg text-sm hover:bg-primary-dark transition-colors">
                Sayfayı Yenile
            </button>
        </div>

        <!-- Visualization -->
        <div id="tree-viz" class="w-full h-full min-h-[600px] cursor-grab active:cursor-grabbing touch-none"></div>
        
        <!-- Legend / Info -->
        <div class="absolute bottom-4 left-4 right-4 sm:left-auto sm:right-6 bg-white/90 backdrop-blur-md p-3 rounded-xl border border-outline-variant/20 shadow-lg text-xs flex flex-wrap gap-3 justify-center sm:justify-start z-10">
            <div class="flex items-center gap-1.5">
                <span class="w-3 h-3 rounded-full bg-primary"></span>
                <span class="text-on-surface font-medium">Dolu Pozisyon</span>
            </div>
            <div class="flex items-center gap-1.5">
                <span class="w-3 h-3 rounded-full border-2 border-dashed border-outline-variant"></span>
                <span class="text-on-surface font-medium">Boş Pozisyon</span>
            </div>
        </div>
    </div>
</div>

<script src="https://d3js.org/d3.v7.min.js"></script>

<script>
let svg, g, zoom;
let allUsers = []; // Tüm kullanıcıların düz listesi
const container = document.getElementById('tree-search').closest('.min-h-\\[calc\\(100vh-80px\\)\\]') ? document.getElementById('tree-viz') : document.getElementById('tree-viz'); // Fallback logic removed for clarity

function showError(message) {
    document.getElementById('loading-state').style.display = 'none';
    document.getElementById('error-state').style.display = 'flex';
    document.getElementById('error-message').textContent = message;
    console.error(message);
}

async function initTree() {
    try {
        if (typeof d3 === 'undefined') {
            throw new Error("D3.js kütüphanesi yüklenemedi. İnternet bağlantınızı kontrol edin.");
        }

        const response = await fetch('/api/tree/{{ user_id }}');
        if (!response.ok) throw new Error(`Sunucu hatası: ${response.status}`);
        
        const data = await response.json();
        if (!data) throw new Error("Ağaç verisi bulunamadı.");
        
        // Kullanıcı listesini oluştur
        allUsers = flattenUsers(data);
        
        renderTree(data);
        document.getElementById('loading-state').style.display = 'none';
        
        // Window resize handler
        window.addEventListener('resize', () => {
            clearTimeout(window.resizeTimer);
            window.resizeTimer = setTimeout(() => {
                renderTree(data);
            }, 250);
        });

    } catch (error) {
        showError(error.message || "Ağaç yüklenirken bir hata oluştu.");
    }
}

// Helper: Hiyerarşik veriyi düz listeye çevir
function flattenUsers(node, list = []) {
    if (node.id) {
        list.push({ id: node.id, name: node.name, uye_no: node.uye_no });
    }
    if (node.children) {
        node.children.forEach(child => flattenUsers(child, list));
    }
    return list;
}

// Arama Mantığı
const searchInput = document.getElementById('tree-search');
const searchResults = document.getElementById('search-results');

searchInput.addEventListener('input', (e) => {
    const query = e.target.value.toLowerCase();
    if (query.length < 1) {
        searchResults.classList.add('hidden');
        return;
    }

    const matches = allUsers.filter(u => 
        u.name.toLowerCase().includes(query) || 
        (u.uye_no && u.uye_no.toString().includes(query))
    );

    displayResults(matches);
});

// Dışarı tıklandığında listeyi kapat
document.addEventListener('click', (e) => {
    if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
        searchResults.classList.add('hidden');
    }
});

function displayResults(matches) {
    searchResults.innerHTML = '';
    if (matches.length === 0) {
        searchResults.innerHTML = '<div class="p-3 text-sm text-on-surface-variant text-center">Kullanıcı bulunamadı</div>';
    } else {
        matches.forEach(user => {
            const div = document.createElement('div');
            div.className = 'p-3 hover:bg-surface-container cursor-pointer flex items-center gap-3 border-b border-outline-variant/10 last:border-0';
            div.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center text-primary">
                    <span class="material-symbols-outlined text-lg">person</span>
                </div>
                <div>
                    <div class="text-sm font-medium text-on-surface">${user.name}</div>
                    <div class="text-xs text-on-surface-variant">Üye No: ${user.uye_no}</div>
                </div>
            `;
            div.onclick = () => {
                focusNode(user.id);
                searchResults.classList.add('hidden');
                searchInput.value = user.name;
            };
            searchResults.appendChild(div);
        });
    }
    searchResults.classList.remove('hidden');
}

function focusNode(userId) {
    const allNodes = d3.selectAll(".node").data();
    const found = allNodes.find(d => d.data.id == userId);
    
    if (found) {
        const width = document.getElementById('tree-viz').clientWidth;
        const height = document.getElementById('tree-viz').clientHeight;
        const scale = 1.5;
        
        const x = -found.x * scale + width / 2;
        const y = -found.y * scale + height / 2;
        
        svg.transition().duration(750).call(
            zoom.transform,
            d3.zoomIdentity.translate(x, y).scale(scale)
        );
        
        // Highlight
        const nodeElement = d3.selectAll(".node")
            .filter(d => d === found)
            .select("rect");
            
        nodeElement
            .transition().duration(300)
            .attr("stroke", "#7C3AED")
            .attr("stroke-width", 4)
            .transition().duration(1000)
            .attr("stroke-width", 0);
    }
}

function renderTree(data) {
    // Temizle
    d3.select("#tree-viz").selectAll("*").remove();

    const container = document.getElementById('tree-viz');
    let width = container.clientWidth;
    let height = container.clientHeight;
    
    // Fallback boyutlar
    if (!width || width === 0) width = window.innerWidth;
    if (!height || height === 0) height = 600;
    
    // Mobil optimizasyonu için node boyutları
    const isMobile = width < 768;
    const nodeWidth = isMobile ? 140 : 180;
    const nodeHeight = isMobile ? 60 : 70;
    const verticalGap = isMobile ? 80 : 100;

    zoom = d3.zoom()
        .scaleExtent([0.1, 2])
        .on("zoom", (event) => {
            g.attr("transform", event.transform);
        });

    svg = d3.select("#tree-viz")
        .append("svg")
        .attr("width", width)
        .attr("height", height)
        .call(zoom)
        .on("dblclick.zoom", null); // Çift tıklama zoom'unu kapat

    g = svg.append("g");

    const treeLayout = d3.tree()
        .nodeSize([nodeWidth + 20, verticalGap + nodeHeight]);

    const root = d3.hierarchy(data);
    treeLayout(root);

    // Başlangıç pozisyonunu ayarla (Ortala ve biraz aşağıdan başlat)
    const initialTransform = d3.zoomIdentity
        .translate(width / 2, 50)
        .scale(isMobile ? 0.7 : 0.9);
    
    svg.call(zoom.transform, initialTransform);

    // Bağlantılar (Curved Lines)
    g.selectAll(".link")
        .data(root.links())
        .enter()
        .append("path")
        .attr("class", "link")
        .attr("d", d3.linkVertical()
            .x(d => d.x)
            .y(d => d.y))
        .attr("fill", "none")
        .attr("stroke", "#E0E0E0")
        .attr("stroke-width", 2);

    // Node Grupları
    const nodes = g.selectAll(".node")
        .data(root.descendants())
        .enter()
        .append("g")
        .attr("class", "node")
        .attr("transform", d => `translate(${d.x},${d.y})`)
        .style("cursor", "pointer")
        .on("click", (event, d) => {
            if (d.data.id) {
                // Dolu node tıklama işlemi (Örn: Detay modalı açılabilir)
                console.log("Üye ID:", d.data.id);
            } else {
                // Boş node tıklama işlemi (Yeni kayıt)
                window.location.href = `/kayit?parent=${d.data.parent}&kol=${d.data.kol}`;
            }
        });

    // Node Kartı (Gölge ve Arkaplan)
    nodes.append("rect")
        .attr("width", nodeWidth)
        .attr("height", nodeHeight)
        .attr("x", -nodeWidth / 2)
        .attr("y", 0)
        .attr("rx", 12)
        .attr("fill", d => d.data.id ? "#FFFFFF" : "#F8F9FA")
        .attr("stroke", d => d.data.id ? "#6750A4" : "#D1D5DB")
        .attr("stroke-width", d => d.data.id ? 0 : 1)
        .attr("stroke-dasharray", d => d.data.id ? "0" : "4,4")
        .style("filter", d => d.data.id ? "drop-shadow(0px 4px 6px rgba(0,0,0,0.05))" : "none");

    // İsim ve Bilgiler
    const textGroup = nodes.append("g")
        .attr("transform", `translate(0, ${nodeHeight/2 - 8})`);

    // İsim
    textGroup.append("text")
        .attr("text-anchor", "middle")
        .attr("font-family", "'Inter', sans-serif")
        .attr("font-size", isMobile ? "12px" : "13px")
        .attr("font-weight", "600")
        .attr("fill", d => d.data.id ? "#1F2937" : "#9CA3AF")
        .text(d => {
            const name = d.data.name;
            return name.length > 15 ? name.substring(0, 14) + "..." : name;
        });

    // PV Bilgisi (Sadece dolu ise)
    textGroup.filter(d => d.data.id).append("text")
        .attr("text-anchor", "middle")
        .attr("y", 18)
        .attr("font-family", "'Inter', sans-serif")
        .attr("font-size", "10px")
        .attr("font-weight", "500")
        .attr("fill", "#6B7280")
        .text(d => d.data.pv);
        
    // Boş ise "Yeni Kayıt" yazısı
    textGroup.filter(d => !d.data.id).append("text")
        .attr("text-anchor", "middle")
        .attr("y", 16)
        .attr("font-family", "'Inter', sans-serif")
        .attr("font-size", "11px")
        .attr("fill", "#9CA3AF")
        .text("Yeni Kayıt");
}

// Kontrol Fonksiyonları
function zoomIn() {
    svg.transition().duration(300).call(zoom.scaleBy, 1.2);
}

function zoomOut() {
    svg.transition().duration(300).call(zoom.scaleBy, 0.8);
}

function resetZoom() {
    const width = document.getElementById('tree-viz').clientWidth;
    const isMobile = width < 768;
    svg.transition().duration(750).call(
        zoom.transform,
        d3.zoomIdentity.translate(width / 2, 50).scale(isMobile ? 0.7 : 0.9)
    );
}

initTree();
</script>
{% endblock %}